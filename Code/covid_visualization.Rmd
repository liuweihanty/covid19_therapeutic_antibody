---
title: "covid19_visualisation"
author: "Weihan Liu"
date: "19/05/2020"
output: html_document
---

```{r}
library(RCurl) #for fetching google spreadsheet data
library(mosaic)
library(tidyr)

covid <- getURL("https://docs.google.com/spreadsheets/d/e/2PACX-1vRcKtlvdTC90b8Qs0SMoqFmfXPiEjAwzA_gZ_nsqZEvjA0htzCr1HeAMKdfeeMH7nFyz1p-F4_Lmj1W/pub?output=csv")
covid <- read.csv(textConnection(covid))

str(covid)
```

Company Analysis
```{r}
company <- covid %>%
        dplyr::select(c("Developer.Reseacher","ID","Campaign.ID"))

company <- separate(company, Developer.Reseacher, into = c("company1","company2","company3","company4","company5","company6","company7","company8"),sep = "/")

company <- gather(company[1:8],key = "company",value = "count") 
company <- company[2]

```


Country Analysis
```{r}
country <- covid %>%
        dplyr::select(c("Country","Status","Developer.Reseacher","Target"))
country$Country <- as.character(country$Country)
country$Status <- as.character(country$Status)

country <- separate(country,Country,into =
             c("1","2","3","4","5","6","7","8","9","10"))
```

```{r}
sub_piece <- country[c(1,11,12,13)]
for (i in 2:(ncol(country)-3)) {
    sub_piece_next <- country[c(i,11,12,13)]
    names(sub_piece) <- names(sub_piece_next) 
    sub_piece <- rbind(sub_piece,sub_piece_next)
}

sub_piece <- sub_piece %>% 
    rename(country = "10") %>%
    data.table::setorder(country) %>%
    filter(is.na(country) == FALSE)
    
#get rid of unknown clinical status
sub_piece <- filter(sub_piece, Status != "Unknown")
#add a counter column
sub_piece <- mutate(sub_piece,count = 1)

table(sub_piece$Status)
sub_piece[sub_piece == "Phase I"] <- "Phase 1"

```
Plotting
```{r}
library(plotly)
library(viridis)
library(hrbrthemes)
library(forcats)

#order the clinical status column
sub_piece$Status <- factor(sub_piece$Status, levels = c("Phase 3","Phase 2/3","Phase 2","Phase 1/2","Phase 1","Preclinical","Discovery"))

country_plot <- ggplot(data = sub_piece, aes(x = fct_infreq(country), y = count, fill = Status)) + 
    geom_bar(position = "stack",stat = "identity") +
    #scale_fill_viridis(discrete = T,direction = -1) +
    #theme_ipsum() +
    scale_fill_brewer(palette ="RdBu") +
    theme_classic()+
    theme(axis.text.x=element_text(angle=45, hjust=1)) + 
    ylab("Numbers in Development") +
    xlab("Countries") +
    ggtitle("Status of Antibody Therapeutics by Country") +
    theme(plot.title = element_text(hjust = 0.5)) +
    coord_cartesian(ylim = c(0, 80)) 
    
    
    

country_plot

#convert to a plotly plot
country_fig <- ggplotly(country_plot,tooltip = "Status")

country_fig



htmlwidgets::saveWidget(country_fig, file = "/Users/weihan/Desktop/by_country.html")        
```






Just plot the total number of Ab in devlopment for each country without clinical status information
```{r}
#extract the country column as a vector
country_vec <- country$Country

#split the rows with multiple countries by their seperator "/" anbd update the country vector
country_vec <- strsplit(country_vec,split = "/") %>% unlist() 

country_vec <- as.data.frame(table(country_vec)) 

country <- dplyr::rename(country_vec,
                      Country = country_vec,
                      number_in_development = Freq)


#order by the value of  number_in_development
country <- country[order(country$number_in_development,decreasing = TRUE),]

```

Plotting using plotly
```{r}
library(plotly)

country_plot <- ggplot(data = country, aes(x = Country, y = number_in_development)) +                    
                geom_bar(stat = "identity",fill='steelblue') +
                theme(axis.text.x=element_text(angle=45, hjust=1)) + 
                ylab("numbers in development") +
                xlab("Countries") +
                ggtitle("Numbers of Therapeutics Antibodies in Development by country")

country_fig <- ggplotly(country_plot)

country_fig



htmlwidgets::saveWidget(country_fig, file = "/Users/weihan/Desktop/by_country.html")        
```

build a plotly dash
```{r}
library(dash)
library(dashCoreComponents)
library(dashHtmlComponents)

app <- Dash$new()
app$layout(
    htmlDiv(
        list(
            dccGraph(figure=country_fig) 
        )
     )
)

app$run_server(debug=TRUE, dev_tools_hot_reload=FALSE)
```

